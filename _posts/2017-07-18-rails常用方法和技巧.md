---
layout: post
title: Rails常用方法和技巧
categories: [Rails, Ruby]
tags: [ruby, rails, Time, where]
---
# 转义

## %Q

用于替代双引号的字符串


~~~ruby
>> %Q(Joe said: "Frank said: "#{what_frank_said}"")
=> "Joe said: "Frank said: "Hello!"""
~~~

(...)也可用其他非数字字母的符号或成对的符号代替, 诸如[...], !...!, +...+,{...}, <...>等.
以下写法全部与上面等效:

~~~ruby
%Q!Joe said: "Frank said: "#{what_frank_said}""!
%Q[Joe said: "Frank said: "#{what_frank_said}""]
%Q+Joe said: "Frank said: "#{what_frank_said}""+
~~~

除此之外还可以省略Q写作:

~~~ruby
%/Joe said: "Frank said: "#{what_frank_said}""/
"Joe said: "Frank said: "Hello!""" 
~~~

## %q

与 %Q类似, 但是表示的是单引号字符串.

## %W

与%Q类似，表示其中的元素被双引号括起的数组

~~~ruby
>> %W(#{foo} Bar Bar\ with\ space)
=> ["Foo", "Bar", "Bar with space"] 
~~~

## %x

执行一段脚本并发挥标准输出内容

~~~ruby
>> %x(echo foo:#{foo})
=> "foo:Foo\n" 
~~~

## %r

用于正则表达式

~~~ruby
>> %r(/home/#{foo})
=> "/\\/home\\/Foo/" 
~~~

## %s

用于表示symbol，但是不会对其中表达式等内容进行转化

~~~ruby
>> %s(foo)
=> :foo
>> %s(foo bar)
=> :"foo bar"
>> %s(#{foo} bar)
=> :"\#{foo} bar"
~~~

## %i

Ruby 2.0 之后引入的语法, 用于生成一个symbol数组

~~~ruby
 > %i(a b c)
=> [:a, :b, :c] 
~~~

## 时间

~~~
Time.now.yesterday
Time.now.ago(2.days).end_of_day
Time.now.next_month.beginning_of_month
30.seconds.ago
1.week.ago
1.weeks.ago #没有单复数的区别
2.week.ago
2.weeks.ago
1.day.ago
1.days.ago
2.day.ago
2.days.ago
Time.now - 2.days
~~~

## 链接

~~~
link_to "链接文本", {action: :index, controller: :home, }
~~~

## ActiveRecord查询


### 按时间范围查询
~~~
User.where(date => 30.days.ago..Time.now)
User.where('created_at < :sixty_days_ago', sixty_days_ago: Time.now - 60.days)
User.where(created_at: Time.current.all_week) # all_day, all_week, all_quarter, all_year
~~~

## 统计

~~~
{a: 1, b: 2}.values.sum # Hash计算所有value的和
{a: 1, b: 2}.sort_by { |key, value| value}
~~~

## Rake命令

rails的优势之一是有一套很强大的自动化工具，辅助你去完成一些模板生成(rails命令, 5.0以后rake命令可以直接用rails命令来执行)，数据库管理，数据迁移，问题诊断等。 熟练掌握rake能把你从简单重复劳动中解放出来，集中精力去思考一些业务相关的问题。

~~~
rake -T     # 显示所有的rake tasks
rails -h    # 查看所有rails命令，包括rake命令

rake routes # 查看所有路由, 路由里面的prefix就是我们在link_to里面用到的路径参数来源
rake db:create
rake db:drop
~~~



## Rails Console
Rails console是非常重要的一个调试入口，对问题诊断，功能开发，测试都非常有帮助。熟练掌握rails console的技能对开发能起到事半功倍的作用。

### 基础操作

~~~ruby
reload! # 热重启rails console
Movie.wh<tab> # 自动补全命令
movies = _  # 下划线代表上一个命令的返回值

"".methods.grep(/case/).sort # 查找方法
ClassName.instance_methods   # 查找所有实例方法

Dir["your-directory/**/*"].length # 数有多少个文件
~~~

### 调试请求

~~~ruby
app.get('/')
response = app.response
response.cookies
>> app.session[:user_id]
=> 7

app.topics_path
app.get(app.root_path)

>> app.movies_path
=> "/movies"

>> app.movie_path(Movie.first)
=> "/movies/1"


ApplicationController.allow_forgery_protection = false # disable CSRF token in console
app.post "/users/sign_in", email: "foo@bar.com", password: "foobar"
~~~

### 调试helper 方法

~~~ruby
irb > helper.link_to("Ruby China", "http://ruby-china.org")
=> "<a href=\"http://ruby-china.org\">Ruby China</a>" 
irb > helper.truncate("Here is Ruby China.", length: 15)
=> "Here is Ruby..." 

>> helper.pluralize(3, 'mouse')
=> "3 mice"

>> helper.number_to_currency(1.50)
=> "$1.50"

>> helper.truncate("Iron Man", length: 7)
=> "Iron..."


>> helper.title_tag(Movie.first)
=> "<title>Flix - Iron Man</title>"

>> helper.poster_image_for(Movie.first)
=> "<img alt=\"Ironman\" src=\"/assets/ironman.png\" />"
~~~

### 使用source_location方法查看方法在哪里定义的

~~~ruby
irb >Topic.instance_method(:destroy).source_location
 => ["/Users/jason/.rvm/gems/ruby-1.9.3-p0/gems/mongoid-2.4.8/lib/mongoid/persistence.rb", 30] 
irb >Topic.method(:destroy_all).source_location
 => ["/Users/jason/.rvm/gems/ruby-1.9.3-p0/gems/mongoid-2.4.8/lib/mongoid/persistence.rb", 239]
~~~

### 进入对象

~~~ruby
>> irb app

>> get "/movies"
=> 200

>> get "/users/1"
=> 302
~~~

### app object

app是rails console里面内置的变量.可以用于调试application的功能,具体调试方法见上面章节。app对象有以下方法可以供使用。

~~~ruby
app
app.host
app.class
app.methods
app.method(:get).source_location
app.main_app
app.main_app.methods
app.root_path
app.root_url
app.user_path(3, sort: "yo yo") #=> "/users/3?sort=yo+yo"
app.name_path
app.project_path(Project.first)
app.get "/users/1"
app.response
app.response.header
app.response.body
app.response.redirect_url
app.session[:user_id]
app.cookies
app.flash
~~~

## scaffold

~~~shell
rails destroy scaffold product
rails g scaffold product parent:references
~~~

__active record 数据类型__

1. `:binary`,
1. `:boolean`,
1. `:date`,
1. `:datetime`,
1. `:decimal`,
1. `:float`,
1. `:integer`,
1. `:string`,
1. `:text`,
1. `:time`,
1. `:timestamp`

# 调试

~~~
Object.ancestors
q.method(:page).source_location # 查看某方法所在的地方
gem dependency -R kaminari # 查看kaminari相关的依赖和被依赖关系
gem dependency --reverse-dependencies will_paginate
~~~

## 代码内嵌数据

读取每一行数据

~~~ruby
DATA.each_line do |line|
  puts line
end

__END__
Doom
Quake
Diablo
~~~

源代码里面内嵌模板做渲染

~~~ruby
require 'erb'

time = Time.now
renderer = ERB.new(DATA.read)
puts renderer.result()

__END__
The current time is <%= time %>.
~~~

通过`rewind`方法读取整个源文件.
~~~ruby
DATA.rewind
puts DATA.read # prints the entire source file

__END__
meh
~~~

[DATA和__END___讲代码和数据混合](https://ruby-china.org/topics/27040)
## 参考

1. [how-do-you-do-relative-time-in-rails](https://stackoverflow.com/questions/195740/how-do-you-do-relative-time-in-rails)
2. [来自37signals的3个Rails console技巧](https://ruby-china.org/topics/3506)
