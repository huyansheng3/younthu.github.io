---
layout: post
title: Rails常用方法和技巧
categories: [Rails, Ruby]
tags: [ruby, rails, Time, where]
---

## 时间

~~~
Time.now.yesterday
Time.now.ago(2.days).end_of_day
Time.now.next_month.beginning_of_month
30.seconds.ago
1.week.ago
1.weeks.ago #没有单复数的区别
2.week.ago
2.weeks.ago
1.day.ago
1.days.ago
2.day.ago
2.days.ago
Time.now - 2.days
~~~

## 链接

~~~
link_to "链接文本", {action: :index, controller: :home, }
~~~

## ActiveRecord查询


### 按时间范围查询
~~~
User.where(date => 30.days.ago..Time.now)
User.where('created_at < :sixty_days_ago', sixty_days_ago: Time.now - 60.days)
User.where(created_at: Time.current.all_week) # all_day, all_week, all_quarter, all_year
~~~

## 统计

~~~
{a: 1, b: 2}.values.sum # Hash计算所有value的和
{a: 1, b: 2}.sort_by { |key, value| value}
~~~

## Rake命令

查看所有Task命令

~~~
rake -T
~~~


~~~
rake db:create
rake db:drop
~~~



## Rails Console
Rails console是非常重要的一个调试入口，对问题诊断，功能开发，测试都非常有帮助。熟练掌握rails console的技能对开发能起到事半功倍的作用。

### 基础操作

~~~ruby
reload! # 热重启rails console
Movie.wh<tab> # 自动补全命令
movies = _  # 下划线代表上一个命令的返回值

"".methods.grep(/case/).sort # 查找方法
ClassName.instance_methods   # 查找所有实例方法

Dir["your-directory/**/*"].length # 数有多少个文件
~~~

### 调试请求

~~~ruby
app.get('/')
response = app.response
response.cookies
>> app.session[:user_id]
=> 7

app.topics_path
app.get(app.root_path)

>> app.movies_path
=> "/movies"

>> app.movie_path(Movie.first)
=> "/movies/1"


ApplicationController.allow_forgery_protection = false # disable CSRF token in console
app.post "/users/sign_in", email: "foo@bar.com", password: "foobar"
~~~

### 调试helper 方法

~~~ruby
irb > helper.link_to("Ruby China", "http://ruby-china.org")
=> "<a href=\"http://ruby-china.org\">Ruby China</a>" 
irb > helper.truncate("Here is Ruby China.", length: 15)
=> "Here is Ruby..." 

>> helper.pluralize(3, 'mouse')
=> "3 mice"

>> helper.number_to_currency(1.50)
=> "$1.50"

>> helper.truncate("Iron Man", length: 7)
=> "Iron..."


>> helper.title_tag(Movie.first)
=> "<title>Flix - Iron Man</title>"

>> helper.poster_image_for(Movie.first)
=> "<img alt=\"Ironman\" src=\"/assets/ironman.png\" />"
~~~

### 使用source_location方法查看方法在哪里定义的

~~~ruby
irb >Topic.instance_method(:destroy).source_location
 => ["/Users/jason/.rvm/gems/ruby-1.9.3-p0/gems/mongoid-2.4.8/lib/mongoid/persistence.rb", 30] 
irb >Topic.method(:destroy_all).source_location
 => ["/Users/jason/.rvm/gems/ruby-1.9.3-p0/gems/mongoid-2.4.8/lib/mongoid/persistence.rb", 239]
~~~

### 进入对象

~~~ruby
>> irb app

>> get "/movies"
=> 200

>> get "/users/1"
=> 302
~~~

### app object

app是rails console里面内置的变量.可以用于调试application的功能,具体调试方法见上面章节。app对象有以下方法可以供使用。

~~~ruby
app
app.host
app.class
app.methods
app.method(:get).source_location
app.main_app
app.main_app.methods
app.root_path
app.root_url
app.user_path(3, sort: "yo yo") #=> "/users/3?sort=yo+yo"
app.name_path
app.project_path(Project.first)
app.get "/users/1"
app.response
app.response.header
app.response.body
app.response.redirect_url
app.session[:user_id]
app.cookies
app.flash
~~~

## scaffold

~~~shell
rails destroy scaffold product
rails g scaffold product parent:references
~~~

__active record 数据类型__

1. `:binary`,
1. `:boolean`,
1. `:date`,
1. `:datetime`,
1. `:decimal`,
1. `:float`,
1. `:integer`,
1. `:string`,
1. `:text`,
1. `:time`,
1. `:timestamp`

# 调试

~~~
Object.ancestors
q.method(:page).source_location # 查看某方法所在的地方
gem dependency -R kaminari # 查看kaminari相关的依赖和被依赖关系
gem dependency --reverse-dependencies will_paginate
~~~

## 参考

1. [how-do-you-do-relative-time-in-rails](https://stackoverflow.com/questions/195740/how-do-you-do-relative-time-in-rails)
2.[来自37signals的3个Rails console技巧](https://ruby-china.org/topics/3506)
